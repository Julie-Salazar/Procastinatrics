{% extends "base.html" %}

{% block title %}Friend Receipts{% endblock %}

{% block head_links %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/friend-receipts.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/receipt-styles.css') }}">
{% endblock %}

{% block content %}
<main class="main-content">
  <h1>Friend Receipts</h1>

  <!-- Hidden Debug Info (Press 'd' key to toggle) -->
  <div id="debug-info" style="background-color: #f0f0f0; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; display: none;">
    <h3>Debug Info</h3>
    {% if friend_receipts %}
      <ul>
      {% for item in friend_receipts %}
        <li>
          <p><strong>Receipt ID:</strong> {{ item.receipt.receipt_id }}</p>
          <p><strong>Receipt Time:</strong> {{ item.receipt.time }}</p>
          <p><strong>Formatted Date:</strong> {{ item.receipt.time|timestamp_to_date }}</p>
          <p><strong>Procrastination:</strong> {{ item.receipt.hours_procrastinated }}</p>
          <p><strong>Gaming:</strong> {{ item.receipt.hours_gaming }}</p>
          <p><strong>Productive:</strong> {{ item.receipt.hours_productive }}</p>
          <p><strong>Sender Email:</strong> {{ item.sender.email }}</p>
        </li>
      {% endfor %}
      </ul>
    {% else %}
      <p>No receipts found</p>
    {% endif %}
  </div>

  <!-- Carousel Container -->
  <div class="carousel-container">
    <!-- Left Arrow -->
    <button class="carousel-arrow left-arrow" id="prevBtn">
      <svg width="64" height="64" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M31 12L17 24L31 36" stroke="#78E08F" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <!-- Receipt Display Area -->
    <div class="receipt-display" id="receiptCarousel">
      {% if friend_receipts %}
        {% for item in friend_receipts %}
          <div class="receipt-wrapper" data-index="{{ loop.index0 }}" {% if not loop.first %}style="display: none;"{% endif %}>
            <div class="receipt-container" id="receipt-container-{{ loop.index }}">
              <img src="{{ url_for('static', filename='img/receipt-base.svg') }}" alt="receipt" />
              
              <!-- Use the timestamp from the friend's receipt to format date/time -->
              {% if item.receipt.time %}
                {% set receipt_date = item.receipt.time|timestamp_to_date('%a, %b %d, %Y') %}
                {% set receipt_time = item.receipt.time|timestamp_to_time('%I:%M:%S %p') %}
              {% else %}
                {% set receipt_date = 'Date unavailable' %}
                {% set receipt_time = 'Time unavailable' %}
              {% endif %}
              
              <!-- Use actual percentages from the friend's receipt with explicit type conversion -->
              {% set procrastination_percent = item.receipt.hours_procrastinated|int|default(0) %}
              {% set gaming_percent = item.receipt.hours_gaming|int|default(0) %}
              {% set productive_percent = item.receipt.hours_productive|int|default(0) %}
              
              <!-- Generate a status message based on actual productivity -->
              {% if productive_percent >= 70 %}
                {% set status_message = "PRODUCTIVITY MASTER" %}
              {% elif productive_percent >= 50 %}
                {% set status_message = "DOING GOOD" %}
              {% elif productive_percent >= 30 %}
                {% set status_message = "NEEDS IMPROVEMENT" %}
              {% else %}
                {% set status_message = "HELLA BAD BRUH" %}
              {% endif %}
              
              <!-- Receipt Text Elements -->
              <div class="receipt-text receipt-date-time" style="top: 105px; left: 160px;">
                {{ receipt_date }} â€¢ {{ receipt_time }}
              </div>
              
              <div class="receipt-text receipt-number" style="top: 140px; left: 260px;">
                #{{ item.receipt.receipt_id|default('0000') }}
              </div>
              
              <div class="receipt-text status-value" style="top: 210px; left: 280px;">
                {{ status_message }}
              </div>
              
              <div class="receipt-text customer-value" style="top: 260px; left: 220px;">
                {{ item.sender.email|default('Unknown User') }}
              </div>
              
              <div class="receipt-text proc-hours-label" style="top: 295px; left: 140px;">
                % TIME RATIO %
              </div>
              
              <div class="receipt-text proc-hours-value" style="top: 355px; left: 340px;">
                {{ procrastination_percent }}%
              </div>
              
              <div class="receipt-text gaming-hours-value" style="top: 385px; left: 340px;">
                {{ gaming_percent }}%
              </div>
              
              <div class="receipt-text productive-hours-value" style="top: 418px; left: 340px;">
                {{ productive_percent }}%
              </div>
              
              <!-- Calculate actual total hours from percentages -->
              <div class="receipt-text total-hours-value" style="top: 480px; left: 340px;">
                {{ total_hours|default(0) }} hrs
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">ðŸ“¬</div>
          <h3>No Friend Receipts Yet</h3>
          <p>When friends share their productivity receipts with you, they'll appear here.</p>
          <a href="{{ url_for('share.share_requests') }}" class="action-btn">Check Pending Requests</a>
        </div>
      {% endif %}
    </div>

    <!-- Right Arrow -->
    <button class="carousel-arrow right-arrow" id="nextBtn">
      <svg width="64" height="64" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M17 12L31 24L17 36" stroke="#78E08F" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Add debug toggle with 'd' key press
    document.addEventListener('keydown', function(event) {
      if (event.key === 'd') {
        const debugDiv = document.getElementById('debug-info');
        debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
      }
    });
    
    const receiptWrappers = document.querySelectorAll('.receipt-wrapper');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    // If no receipts, disable both buttons but keep them visible
    if (!receiptWrappers.length) {
      prevBtn.disabled = false;
      nextBtn.disabled = false;
      prevBtn.style.opacity = 0.5;
      nextBtn.style.opacity = 0.5;
      return;
    }
    
    let currentIndex = 0;
    const maxIndex = receiptWrappers.length - 1;
    
    // Function to update displayed receipt
    function updateDisplay() {
      // Hide all receipts
      receiptWrappers.forEach(wrapper => {
        wrapper.style.display = 'none';
      });
      
      // Show current receipt
      receiptWrappers[currentIndex].style.display = 'block';
      
      // Update button states
      prevBtn.disabled = currentIndex === 0;
      prevBtn.style.opacity = currentIndex === 0 ? 0.5 : 1;
      nextBtn.disabled = currentIndex === maxIndex;
      nextBtn.style.opacity = currentIndex === maxIndex ? 0.5 : 1;
    }
    
    // Previous button click
    prevBtn.addEventListener('click', function () {
      if (currentIndex > 0) {
        currentIndex--;
        updateDisplay();
      }
    });
    
    // Next button click
    nextBtn.addEventListener('click', function () {
      if (currentIndex < maxIndex) {
        currentIndex++;
        updateDisplay();
      }
    });
    
    // Initialize display
    updateDisplay();
  });
</script>
{% endblock %}