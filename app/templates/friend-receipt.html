{% extends "base.html" %}

{% block title %}Friend Receipts{% endblock %}

{% block head_links %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/friend-receipts.css') }}">
{% endblock %}

{% block content %}
<main class="main-content">
  <h1>Friend Receipts</h1>

  <!-- Hidden Debug Info (Press 'd' key to toggle) -->
  <div id="debug-info" style="background-color: #f0f0f0; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; display: none;">
    <h3>Debug Info</h3>
    {% if friend_receipts %}
      <ul>
        {% for item in friend_receipts %}
          <li>
            <p><strong>Receipt ID:</strong> {{ item.receipt.receipt_id }}</p>
            <p><strong>Receipt Time:</strong> {{ item.receipt.time }}</p>
            <p><strong>Formatted Date:</strong> {{ item.receipt.time|timestamp_to_date }}</p>
            <p><strong>Procrastination:</strong> {{ item.receipt.hours_procrastinated }}</p>
            <p><strong>Gaming:</strong> {{ item.receipt.hours_gaming }}</p>
            <p><strong>Productive:</strong> {{ item.receipt.hours_productive }}</p>
            <p><strong>Sender Email:</strong> {{ item.sender.email }}</p>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No receipts found</p>
    {% endif %}
  </div>
  

  <!-- Carousel Container -->
  <div class="carousel-container">
    <button class="carousel-arrow left-arrow" id="prevBtn">
      <svg width="64" height="64" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M31 12L17 24L31 36" stroke="#78E08F" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="receipt-display" id="receiptCarousel">
      {% if friend_receipts %}
        {% for item in friend_receipts %}
          {% set total_hours = item.receipt.hours_procrastinated + item.receipt.hours_gaming + item.receipt.hours_productive %}
          {% set receipt_date = item.receipt.time|timestamp_to_date('%a, %b %d, %Y') if item.receipt.time else 'Date unavailable' %}
          {% set receipt_time = item.receipt.time|timestamp_to_time('%I:%M:%S %p') if item.receipt.time else 'Time unavailable' %}
          {% set procrastination_percent = item.receipt.hours_procrastinated|int %}
          {% set gaming_percent = item.receipt.hours_gaming|int %}
          {% set productive_percent = item.receipt.hours_productive|int %}
          {% set status_message = "PRODUCTIVITY MASTER" if productive_percent >= 70 else "DOING GOOD" if productive_percent >= 50 else "NEEDS IMPROVEMENT" if productive_percent >= 30 else "HELLA BAD BRUH" %}

          <div class="receipt-wrapper" data-index="{{ loop.index0 }}" {% if not loop.first %}style="display: none;"{% endif %}>
            <div class="receipt-container" id="receipt-container-{{ loop.index }}">
              <img src="{{ url_for('static', filename='img/receipt-base.svg') }}" alt="receipt" />

              <div class="receipt-text receipt-date-time" style="top: 105px; left: 160px;">
                {{ receipt_date }} â€¢ {{ receipt_time }}
              </div>

              <div class="receipt-text receipt-number" style="top: 140px; left: 260px;">
                #{{ item.receipt.receipt_id|default('0000') }}
              </div>

              <div class="receipt-text status-value" style="top: 210px; left: 280px;">
                {{ status_message }}
              </div>

              <div class="receipt-text customer-value" style="top: 260px; left: 220px;">
                {{ item.sender.email|default('Unknown User') }}
              </div>

              <div class="receipt-text proc-hours-label" style="top: 295px; left: 140px;">
                % TIME RATIO %
              </div>

              <div class="receipt-text proc-hours-value" style="top: 355px; left: 340px;">
                {{ procrastination_percent }}%
              </div>

              <div class="receipt-text gaming-hours-value" style="top: 385px; left: 340px;">
                {{ gaming_percent }}%
              </div>

              <div class="receipt-text productive-hours-value" style="top: 418px; left: 340px;">
                {{ productive_percent }}%
              </div>

              <div class="receipt-text total-hours-value" style="top: 480px; left: 340px;">
                {{ total_hours }} hrs
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">ðŸ“¬</div>
          <h3>No Friend Receipts Yet</h3>
          <p>When friends share their productivity receipts with you, they'll appear here.</p>
          <a href="{{ url_for('share.share_requests') }}" class="action-btn">Check Pending Requests</a>
        </div>
      {% endif %}
    </div>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <ul>
      {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <ul>
      {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}


    <button class="carousel-arrow right-arrow" id="nextBtn">
      <svg width="64" height="64" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M17 12L31 24L17 36" stroke="#78E08F" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const receiptWrappers = document.querySelectorAll('.receipt-wrapper');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    let currentIndex = 0;
    const maxIndex = receiptWrappers.length - 1;

    // Debug toggle
    document.addEventListener('keydown', function (event) {
      if (event.key === 'd') {
        const debugDiv = document.getElementById('debug-info');
        debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
      }
    });

    function updateDisplay() {
      receiptWrappers.forEach((wrapper, idx) => {
        wrapper.style.display = idx === currentIndex ? 'block' : 'none';
      });

 

      prevBtn.style.opacity = currentIndex === 0 ? 0.5 : 1;
      nextBtn.style.opacity = currentIndex === maxIndex ? 0.5 : 1;
    }

    if (receiptWrappers.length > 0) {
      updateDisplay();

      prevBtn.addEventListener('click', function () {
        if (currentIndex > 0) {
          currentIndex--;
          updateDisplay();
        }
      });

      nextBtn.addEventListener('click', function () {
        if (currentIndex < maxIndex) {
          currentIndex++;
          updateDisplay();
        }
      });
    }
  });
</script>
{% endblock %}
